(function(p,z){typeof exports=="object"&&typeof module!="undefined"?z(exports):typeof define=="function"&&define.amd?define(["exports"],z):(p=typeof globalThis!="undefined"?globalThis:p||self,z(p.iPuzzler={}))})(this,function(p){"use strict";class z{constructor(e,t,i,s,l){this.uri=i||"",this.cells=e,this.allCells.forEach(r=>r.puzzle=this),this.clues=t,this.focusedCell=null,this.direction="across",this.acrossHeading="Across",this.downHeading="Down",this.hasSolution=s,this.submitUrl=l}isClueBirectional(e){return this.clues.across[e]&&this.clues.down[e]}get allClues(){return this.clues.across.concat(this.clues.down).filter(e=>e)}get allCells(){return this.cells.flat()}switchDirection(){return this.direction=="across"?this.direction="down":this.direction="across"}get width(){return this.cells[0].length}get height(){return this.cells.length}get cookieName(){return this.uri.replace(/[^a-z0-9]+/ig,"-")}getState(){return this.cells.map(e=>e.map(t=>t.value||"_").join("")).join("")}setState(e){let t=e.split(""),i=this.cells.flat();t.forEach((s,l)=>i[l].setValue(s!="_"?s:""))}setFocus(e,t,i){this.setFocusToCell(this.cells[e][t],i)}focusClue(e,t){let i=this.clues[t][e];this.setFocusToClue(i)}setCellValue(e){this.focusedCell&&(this.focusedCell.setValue(e),e&&this.advanceFocus(this.direction))}setFocusToClue(e){this.direction=e.direction,this.setFocusToCell(e.cells[0])}setFocusToCell(e,t){e&&e.hasInput&&(this.focusedCell==e?e.isBirectional&&t&&this.switchDirection():(this.focusedCell=e,e.clues[this.direction]||this.switchDirection()),this.focusedCell=e,this.focusedClue=e.clues[this.direction],this.cells.flat().forEach(i=>i.clearHighlight()),this.allClues.forEach(i=>i.clearHighlight()),this.focusedClue.addHighlight())}getCell(e){return e.isInside(this.cells)?this.cells[e.row][e.col]:null}advanceFocus(e){let t=this.focusedCell.clues[e],i=t.cells.indexOf(this.focusedCell)+1;i<t.cells.length?this.setFocusToCell(t.cells[i]):t.next&&this.setFocusToClue(t.next)}retreatFocus(e){let t=this.focusedCell.clues[e];if(t){let i=t.cells.indexOf(this.focusedCell)-1;i>=0&&this.setFocusToCell(t.cells[i])}}home(){this.setFocusToCell(this.focusedClue.cells[0])}end(){this.setFocusToCell(this.focusedClue.cells[this.focusedClue.cells.length-1])}backspace(){this.setCellValue(""),this.retreatFocus(this.direction)}clearFocus(){this.focusedCell=null,this.focusedClue=null,this.cells.flat().forEach(e=>e.clearHighlight()),this.allClues.forEach(e=>e.clearHighlight())}moveFocus(e){var s;let t=(s=this.focusedCell)==null?void 0:s.position;if(!t)return;let i=this.getCell(t.increment(e));this.setFocusToCell(i)}checkClue(){this.focusedClue&&this.focusedClue.check()}clearClue(){this.focusedClue&&this.focusedClue.clear()}cheatClue(){this.focusedClue&&this.focusedClue.cheat()}checkGrid(){this.allCells.forEach(e=>e.check())}clearGrid(){this.allCells.forEach(e=>e.clear())}cheatGrid(){this.allCells.forEach(e=>e.cheat())}submitGrid(e){var t=decodeURIComponent(document.cookie),i=t.split(/; */).map(s=>s.split("=")).find(s=>s[0]==this.cookieName);i&&i.length>1&&(this.allCells.some(s=>s.style===""&&s.value==="")?alert("You are missing some answers"):(e.elements.answers.value=i[1],e.submit()))}}class C{constructor(e,t){if(this.direction=t,this.number=parseInt(e.number),this.text=e.clue,this.enumeration=e.enumeration,this.label=(e.label||String(this.number)).replace(/\//g,",").toLowerCase(),this.cells=[],this.continuations=[],e.continued&&e.continued.map){this.continuations=e.continued.map(s=>{let l=new C(s,s.direction.toLowerCase());return l.text=`See ${e.number}`,l.direction!=this.direction&&(l.text+=" "+this.direction),l.root=this,l}),this.next=this.continuations[0];for(var i=0;i<this.continuations.length-1;i++)this.continuations[i].next=this.continuations[i+1]}}get elementId(){return`clue-${this.number}-${this.direction}`}get allCells(){var t;let e=(t=this.root)!=null?t:this;return e.cells.concat(e.continuations.map(i=>i.cells).flat())}get allClues(){var t;let e=(t=this.root)!=null?t:this;return[e].concat(e.continuations)}addHighlight(){this.allClues.forEach(e=>e.isActive=!0),this.allCells.forEach(e=>e.addHighlight())}clearHighlight(){this.allClues.forEach(e=>e.isActive=!1)}toClueList(){return[this].concat(this.continuations)}check(){this.allCells.forEach(e=>e.check())}clear(){this.allCells.forEach(e=>e.clear())}cheat(){this.allCells.forEach(e=>e.cheat())}}class b{constructor(e,t){this.row=e,this.col=t}isInside(e){return!(this.row<0||this.row>=e.length||this.col<0||this.col>=e[this.row].length)}increment(e){switch(e){case"up":return new b(this.row-1,this.col);case"left":return new b(this.row,this.col-1);case"down":return new b(this.row+1,this.col);case"across":case"right":return new b(this.row,this.col+1)}}}class E{constructor(e,t,i){if(this.isActive=!1,this.style="",this.position=new b(t,i),this.previous={},this.next={},this.clues={},this.value="",e===null)this.style="blank";else if(typeof e.cell=="number"?this.number=e.cell:typeof e=="number"?this.number=e:this.number=NaN,e.style)switch(e.style.barred){case"T":this.style="barred-top";break;case"L":this.style="barred-left";break;case"TL":this.style="barred-top barred-left";break}else e=="#"&&(this.style="block")}setValue(e){this.hasInput&&(this.value=e&&e.toUpperCase?e.toUpperCase():"")}get isBirectional(){return this.clues.across&&this.clues.down}get hasInput(){return!/bl(an|oc)k/.test(this.style)}addHighlight(){this.isActive=!0}clearHighlight(){this.isActive=!1}isEndOfRange(e){return!!(!this.hasInput||e=="across"&&this.previous.across&&/left/.test(this.style)||e=="down"&&this.previous.down&&/top/.test(this.style))}check(){let e=this.value&&this.value.toUpperCase?this.value.toUpperCase():"",t=this.solution&&this.solution.toUpperCase?this.solution.toUpperCase():"";e!==t&&this.clear()}cheat(){this.solution&&this.setValue(this.solution)}clear(){this.setValue("")}}class f{static parse(e,t,i){var m,v;let s=e.puzzle.map((h,w)=>h.map((x,A)=>new E(x,w,A))),l=f.attachSolutions(s,e.solution),r=Object.keys(e.clues),n=r.find(h=>/^across/i.test(h)),o=r.find(h=>/^down/i.test(h)),a=e.clues[n],u=e.clues[o],c=Array.isArray(a)?a:[];c=c.map(h=>new C(h,"across").toClueList()).flat();let g=Array.isArray(u)?u:[];g=g.map(h=>new C(h,"down").toClueList()).flat();const d={across:[],down:[]};return c.concat(g).forEach(h=>{let w=f.findCellForClue(s,h);w&&(h.position=w.position,h.cells=f.findCellList(s,h.position,h.direction),h.cells.forEach(x=>x.clues[h.direction]=h),d[h.direction][h.number]=h)}),d.across.heading=(m=n.split(":")[1])!=null?m:"Across",d.down.heading=(v=o.split(":")[1])!=null?v:"Down",new z(s,d,t,l,i)}static attachSolutions(e,t){return t?(e.forEach((i,s)=>i.forEach((l,r)=>{if(t[s]&&t[s][r]){let n=t[s][r].value||t[s][r];n.toUpperCase&&/[A-Z]/i.test(n)&&(l.solution=n.toUpperCase())}})),!0):!1}static findCellForClue(e,t){return e.flat().find(i=>i.number==t.number)}static findCellList(e,t,i,s){if(!t.isInside(e))return[];var l=e[t.row][t.col];return l.previous[i]=s,l.isEndOfRange(i)?[]:(s&&(s.next[i]=l),[l].concat(f.findCellList(e,t.increment(i),i,l)))}}var L=(()=>`div.ipuzzler{font-family:Arial,Helvetica,sans-serif;font-size:12px;margin:0;padding:3px;display:grid;grid-template:1fr/auto 1fr 1fr}div.ipuzzler *{line-height:1em}@media only screen and (max-width: 640px){div.ipuzzler{display:block}}@media only screen and (max-width: 320px){div.ipuzzler div.puzzle-grid span span.clue-number{font-size:6px}}div.ipuzzler div#buttons{text-align:center}div.ipuzzler div#buttons button{margin:6px 4px 2px 0;width:6em;background-color:#36f;border:0;padding:4px;color:#fff;font-weight:400;border-radius:4px}div.ipuzzler div#buttons div#grid-buttons button{background-color:#809fff}div.ipuzzler div#buttons div#grid-buttons.no-solution,div.ipuzzler div#buttons div#clue-buttons.no-solution{display:inline}div.ipuzzler div#buttons div#clue-buttons.no-solution button{background-color:#809fff}div.ipuzzler div#buttons div#submit-buttons button{background-color:#36f;padding:6px;width:10em}div.ipuzzler div.clue-bar{display:none}@media only screen and (max-width: 640px){div.ipuzzler div.clue-bar{display:block}}div.ipuzzler div.clue-bar#above-clue-bar{margin-bottom:8px}div.ipuzzler div.clue-bar#below-clue-bar{margin:8px 0}div.ipuzzler div.clue-bar label{font-weight:700}div.ipuzzler div.clue-bar label:after{content:" "}div.ipuzzler div.clue-bar span:before{content:" "}div.ipuzzler div.puzzle-grid{background-color:#ff0;display:grid;background-color:#000;grid-gap:1px;border:1px solid #000;width:420px;height:420px;max-width:100%;box-sizing:border-box;grid-template:repeat(15,1fr)/repeat(15,1fr);margin:0}@media only screen and (max-width: 640px){div.ipuzzler div.puzzle-grid{width:calc(100vw - 10px);height:calc(100vw - 10px)}}@media only screen and (max-width: 320px){div.ipuzzler div.puzzle-grid{width:310px;height:310px}}div.ipuzzler div.puzzle-grid>span{background-color:#fff;text-align:center;position:relative}div.ipuzzler div.puzzle-grid>span label{font-size:8px;position:absolute;margin:0;padding:0;top:1px;left:1px;z-index:0;background:transparent}div.ipuzzler div.puzzle-grid>span.block{background-color:#000}div.ipuzzler div.puzzle-grid>span.blank{background-color:#933}div.ipuzzler div.puzzle-grid>span.barred-top{border-top:3px solid #000}div.ipuzzler div.puzzle-grid>span.barred-left{border-left:3px solid #000}div.ipuzzler div.puzzle-grid>span.highlighted{background-color:#9cf}div.ipuzzler div.puzzle-grid>span input{position:absolute;left:0;right:0;top:0;bottom:0;background-color:transparent;z-index:1;width:100%;height:100%;border:0;margin:0;padding:10% 0 0;font-weight:700;box-sizing:border-box;text-align:center;border-radius:0;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;mix-blend-mode:darken}div.ipuzzler div.puzzle-grid>span input:focus{font-weight:700;background-color:#36f!important;outline:2px solid #000}div.ipuzzler section.puzzle-clue-list{padding:0 8px}@media only screen and (max-width: 640px){div.ipuzzler section.puzzle-clue-list{padding:0}}div.ipuzzler section.puzzle-clue-list h2{font-size:100%;margin:0 0 8px}div.ipuzzler section.puzzle-clue-list ol{cursor:pointer;list-style:none;margin:0;padding:0}div.ipuzzler section.puzzle-clue-list ol li{padding:4px 4px 4px 1.8em;margin:0 0 2px;border-radius:4px;text-indent:-1.8em;line-height:1.2em}div.ipuzzler section.puzzle-clue-list ol li.highlighted{background-color:#9cf}div.ipuzzler section.puzzle-clue-list ol li.halflighted{background-color:#bdf}div.ipuzzler section.puzzle-clue-list ol li label{min-width:1.4em;font-weight:700;display:inline-block;text-indent:0;margin:0;padding:0 .3em 0 .1em}div.ipuzzler section.puzzle-clue-list ol li span:before{content:" "}
`)();class F{constructor(e){this.dom=e,this.spans=[],this.inputs=[],this.labels=[],this.clueListItems=[],this.buttons=[],this.grid=null,this.aboveClueBar=null,this.belowClueBar=null}html(e,t,i){const s=document.createElement(e);for(const[l,r]of Object.entries(t||{}))s.setAttribute(l,r);return i&&(s.innerText=i),s}update(e){this.spans.forEach((t,i)=>t.forEach((s,l)=>{let r=e.cells[i][l];r==e.focusedCell?s.input.focus():s&&s.input&&s.input.blur(),s.input&&(s.input.value=r.value),r.isActive?s.classList.add("highlighted"):s.classList.remove("highlighted")})),this.clueListItems.forEach(t=>{t.clue.isActive?t.clue.root?t.classList.add("halflighted"):t.classList.add("highlighted"):(t.classList.remove("highlighted"),t.classList.remove("halflighted"))}),e.focusedClue?(this.drawClue(e.focusedClue,this.aboveClueBar,!0),this.drawClue(e.focusedClue,this.belowClueBar,!0)):(this.aboveClueBar.innerHTML="",this.belowClueBar.innerHTML=""),this.savePuzzleStateToCookie(e)}savePuzzleStateToCookie(e){var t=e.getState(),i=new Date(2100,1,1);document.cookie=e.cookieName+"="+t+";expires="+i.toUTCString()+";path=/"}loadPuzzleStateFromCookie(e){var t=decodeURIComponent(document.cookie).split(/; */),i=t.map(s=>s.split("=")).find(s=>s[0]==e.cookieName);i&&i.length>1&&e.setState(i[1])}createCellSpan(e,t,i){let s=this.html("span");if(e.style&&(s.className=e.style),e.number){let l=this.html("label");l.innerHTML=e.number,s.appendChild(l),this.labels.push(l)}if(e.hasInput){let l=Object.entries(e.clues).map(o=>{const[a,u]=o;return`clue-${u.number}-${a}`});const r={"data-row":t,"data-col":i,value:e.value};l.length>0&&(r["aria-labelledby"]=l.join(" "));let n=this.html("input",r);s.appendChild(n),s.input=n,this.inputs.push(n)}return s}createClueEnumerationSpan(e){const t=`${e.enumeration.trim().replace(/ /g,",")}`;let i=this.html("span",{"aria-label":`${t} characters.`});return i.innerText=`(${t})`,i}createClueList(e,t){let i=e.clues[t.toLowerCase()],s=`${t.toLowerCase()}-clue-list`,l=this.html("section",{class:"puzzle-clue-list",id:s}),r=this.html("h2");r.innerHTML=i.heading,l.appendChild(r);let n=this.html("ol");return i.forEach(o=>{let a=this.html("li",{id:o.elementId,"data-clue-number":o.number,"data-clue-direction":o.direction});this.drawClue(o,a),a.clue=o,this.clueListItems.push(a),n.appendChild(a)}),l.appendChild(n),l}drawClue(e,t,i){t.innerHTML=e.text;let s=this.html("label",{"aria-label":`Direction ${e.direction}:`});s.innerText=e.label+(i?`${e.direction[0]}`:""),t.insertBefore(s,t.firstChild),e.enumeration&&t.appendChild(this.createClueEnumerationSpan(e))}drawButtons(e,t){const i=this.html("button",{id:"check-clue-button"},"Check clue"),s=this.html("button",{id:"clear-clue-button"},"Clear clue"),l=this.html("button",{id:"cheat-clue-button"},"Cheat clue"),r=e?this.html("div",{id:"clue-buttons"}):this.html("div",{id:"clue-buttons",class:"no-solution"}),n=this.html("button",{id:"check-grid-button"},"Check grid"),o=this.html("button",{id:"clear-grid-button"},"Clear grid"),a=this.html("button",{id:"cheat-grid-button"},"Cheat grid"),u=e?this.html("div",{id:"grid-buttons"}):this.html("div",{id:"grid-buttons",class:"no-solution"});e?(r.appendChild(i),r.appendChild(s),r.appendChild(l),u.appendChild(n),u.appendChild(o),u.appendChild(a),this.buttons.push(i),this.buttons.push(s),this.buttons.push(l),this.buttons.push(n),this.buttons.push(o),this.buttons.push(a)):(r.appendChild(s),u.appendChild(o),this.buttons.push(s),this.buttons.push(o));const c=this.html("div",{id:"buttons"});if(c.appendChild(r),c.appendChild(u),t!==null){const g=this.html("button",{id:"submit-button",type:"button"},"Submit Answers"),d=this.html("div",{id:"submit-buttons"}),m=this.html("form",{method:"POST",action:t}),v=this.html("input",{type:"hidden",id:"answers",name:"answers"});d.appendChild(g),m.appendChild(d),m.appendChild(v),this.buttons.push(g),c.appendChild(m)}return c}addDeveloperStylesheetLink(e){const t=this.html("link",{type:"text/css",rel:"stylesheet",href:"../css/ipuzzler.css"});this.dom.appendChild(t)}render(e){this.loadPuzzleStateFromCookie(e);const t=this.html("div",{class:"ipuzzler"});this.dom.appendChild(t);const i=this.html("style");i.innerText=L,t.appendChild(i),this.addDeveloperStylesheetLink(this.dom),this.grid=this.html("div",{class:"puzzle-grid"}),this.grid.style.gridTemplate=`repeat(${e.height}, 1fr) / repeat(${e.width}, 1fr)`;let s=this.html("div");this.aboveClueBar=this.html("div",{class:"clue-bar",id:"above-clue-bar"}),this.belowClueBar=this.html("div",{class:"clue-bar",id:"below-clue-bar"}),s.appendChild(this.aboveClueBar),s.appendChild(this.grid),s.appendChild(this.belowClueBar),s.appendChild(this.drawButtons(e.hasSolution,e.submitUrl)),t.appendChild(s),this.spans=e.cells.map((l,r)=>l.map((n,o)=>{let a=this.createCellSpan(n,r,o);return this.grid.appendChild(a),a})),t.appendChild(this.createClueList(e,"Across")),t.appendChild(this.createClueList(e,"Down")),this.resize(e)}resize(e){let t=Math.min(this.grid.offsetWidth,this.grid.offsetHeight);var i=Math.ceil(t/(1.8*e.width));i>10&&i<16&&(i=16),this.inputs.forEach(o=>o.style.fontSize=i+"px");var s=Math.ceil(t/(4*e.width));this.labels.forEach(o=>o.style.fontSize=s+"px");let l=Math.min(window.innerWidth,document.body.scrollWidth,document.body.clientWidth),r,n;if(l>768){let o=28;r=e.width*o+e.width+1,n=e.height*o+e.height+1}else r=l-10,n=Math.floor(e.height/e.width*r);this.grid.style.width=r+"px",this.aboveClueBar.style.width=r+"px",this.belowClueBar.style.width=r+"px",this.grid.style.height=n+"px"}}class y extends HTMLElement{constructor(){super(),this.shadow=this.attachShadow({mode:"open"}),this.addEventListener("keydown",this.keydown),window.addEventListener("resize",this.resize.bind(this))}load(e,t){fetch(e).then(i=>i.json()).then(i=>this.init(i,e,t))}init(e,t,i){this.puzzle=f.parse(e,t,i),this.renderer=new F(this.shadow),this.renderer.render(this.puzzle),this.renderer.inputs.forEach(s=>{s.addEventListener("focus",this.inputFocus.bind(this)),s.addEventListener("mousedown",this.inputMouseDown.bind(this))}),this.renderer.clueListItems.forEach(s=>s.addEventListener("click",this.clueListItemClick.bind(this))),this.renderer.buttons.forEach(s=>s.addEventListener("click",this.buttonClick.bind(this))),this.resize()}connectedCallback(){let e=this.getAttribute("src"),t=this.getAttribute("submitUrl");e&&this.load(e,t)}attributeChangedCallback(e,t,i){switch(e){case"url":this.load(i);break}}resize(e){this.renderer&&typeof this.renderer.resize=="function"&&this.renderer.resize(this.puzzle)}inputMouseDown(e){let t=e.target.getAttribute("data-row"),i=e.target.getAttribute("data-col");this.puzzle.setFocus(t,i,!0),this.renderer.update(this.puzzle)}inputFocus(e){let t=e.target.getAttribute("data-row"),i=e.target.getAttribute("data-col");this.puzzle.setFocus(t,i),this.renderer.update(this.puzzle)}clueListItemClick(e){let t=e.target.closest("li"),i=parseInt(t.getAttribute("data-clue-number")),s=t.getAttribute("data-clue-direction");this.puzzle.focusClue(i,s),this.renderer.update(this.puzzle)}buttonClick(e){let t=e.target;switch(t.id){case"check-clue-button":this.puzzle.checkClue();break;case"clear-clue-button":this.puzzle.clearClue();break;case"cheat-clue-button":this.puzzle.cheatClue();break;case"check-grid-button":this.puzzle.checkGrid();break;case"clear-grid-button":this.puzzle.clearGrid();break;case"cheat-grid-button":confirm("Are you sure you want to reveal all solutions?")&&this.puzzle.cheatGrid();break;case"submit-button":this.puzzle.submitGrid(t.closest("form"));break}this.renderer.update(this.puzzle)}keydown(e){if(e.ctrlKey||e.altKey||e.metaKey)return;switch(e.code){case"ArrowUp":this.puzzle.direction="down",this.puzzle.moveFocus("up");break;case"ArrowDown":this.puzzle.direction="down",this.puzzle.moveFocus("down");break;case"ArrowLeft":this.puzzle.direction="across",this.puzzle.moveFocus("left");break;case"ArrowRight":this.puzzle.direction="across",this.puzzle.moveFocus("right");break;case"Home":this.puzzle.home();break;case"End":this.puzzle.end();break;case"Backspace":this.puzzle.backspace();break;case"Delete":this.puzzle.setCellValue("");break;case"Escape":this.puzzle.clearFocus();break}/^[a-z]$/i.test(e.key)&&(this.puzzle.setCellValue(e.key),e.preventDefault()),this.renderer.update(this.puzzle)}static get observedAttributes(){return["url"]}}customElements.define("ipuzzler-puzzle",y),p.IPuzzler=y,Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
